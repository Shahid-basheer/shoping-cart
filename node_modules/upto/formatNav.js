var fs = require('fs');
var tplNavDir = require('./tpl.nav.dir')
var tplNavFile = require('./tpl.nav.file')

module.exports = function formatNav(model, routeName, routePath, type, pathArr) {
	console.log(model, routeName, routePath, type);
	if (model == 'dir') {
		fs.stat('./src/layouts/CoreLayout/authList.js', function (exists) {
  			if (exists !== null) {
  				fs.writeFile(`./src/layouts/CoreLayout/authList.js` , `module.exports.authList = [\n];` , function (err) {
			        if (err) console.log(err);
			        console.info(`new file ./src/layouts/CoreLayout/authList.js`);
				    
  					fs.readFile('./src/layouts/CoreLayout/authList.js', 'utf8', function (err, authList) {
						if (err) { return console.log(err); }
						var index = authList.indexOf('[') + 1;
						var authListPre = authList.slice(0, index);
						var authListLast = authList.slice(index);
						var addNav = tplNavDir(routeName);
						var newContent = authList.indexOf('{') == -1 ? `${authListPre}\n${addNav}\n${authListLast}`:`${authListPre}\n${addNav},\n${authListLast}`;
						
						fs.writeFile(`./src/layouts/CoreLayout/authList.js` , newContent , function (err) {
					        if (err) console.log(err);
					        console.info(`update ./src/layouts/CoreLayout/authList.js`);
					    });
					});
				});
  			} else  {
  				fs.readFile('./src/layouts/CoreLayout/authList.js', 'utf8', function (err, authList) {
					if (err) { return console.log(err); }
					index = authList.indexOf('[') + 1;
					authListPre = authList.slice(0, index);
					authListLast = authList.slice(index);
					addNav = tplNavDir(routeName);
					newContent = authList.indexOf('{') == -1 ? `${authListPre}\n${addNav}\n${authListLast}`:`${authListPre}\n${addNav},\n${authListLast}`;
					
					fs.writeFile(`./src/layouts/CoreLayout/authList.js` , newContent , function (err) {
				        if (err) console.log(err);
				        console.info(`update ./src/layouts/CoreLayout/authList.js`);
				    });
				});
  			}
		});		
		
	} else {
		fs.stat('./src/layouts/CoreLayout/authList.js', function (exists) {
  			// 没有authList文件时
  			if (exists !== null) {
  				fs.writeFile(`./src/layouts/CoreLayout/authList.js` , `module.exports.authList = [\n];` , function (err) {
			        if (err) console.log(err);
			        console.info(`new file ./src/layouts/CoreLayout/authList.js`);
				    
  					fs.readFile('./src/layouts/CoreLayout/authList.js', 'utf8', function (err, authList) {
						if (err) { return console.log(err); }
						index = authList.indexOf('[') + 1;
						authListPre = authList.slice(0, index);
						authListLast = authList.slice(index);
						addNav = tplNavFile(routePath, type);
						var routePathArr = routePath.split('/');
						addNav = `{
    isCurrent : false,
    permissionName : '${routePathArr[0]}',
    childrenMenuList : [
${addNav}
    ]
}`
						newContent = authList.indexOf('{') == -1 ? `${authListPre}\n${addNav}\n${authListLast}`:`${authListPre}\n${addNav},\n${authListLast}`;
						
						fs.writeFile(`./src/layouts/CoreLayout/authList.js` , newContent , function (err) {
					        if (err) console.log(err);
					        console.info(`update ./src/layouts/CoreLayout/authList.js`);
					    });
					});
				});
  			} else  {
  				fs.readFile('./src/layouts/CoreLayout/authList.js', 'utf8', function (err, authList) {
					if (err) { return console.log(err); }
					index = 0;
					for ( var i = 0, len = pathArr.length; i < len; i++ ) {
						if (authList.indexOf(pathArr[i]) > -1) {
							index = authList.indexOf(pathArr[i]) + 1;
							break;
						}
					}
					
					// 如果没有该模块路由，则加入新模块并加入路由
					if (index == 0) {
						index = authList.indexOf('[') + 1;
						authListPre = authList.slice(0, index);
						authListLast = authList.slice(index);
						addNav = tplNavFile(routePath, type);
						var routePathArr = routePath.split('/');
						addNav = `{
    isCurrent : false,
    permissionName : '${routePathArr[0]}',
    childrenMenuList : [
${addNav}
    ]
}`
						newContent = authList.indexOf('{') == -1 ? `${authListPre}\n${addNav}\n${authListLast}`:`${authListPre}\n${addNav},\n${authListLast}`;
					// 如果有该模块路由，则加入路由
					} else {
						authListPre = authList.slice(0, index);
						authListLast = authList.slice(index);
						innerIndex = authListLast.indexOf('[') + 1;
						_authListPre = authListLast.slice(0, innerIndex);
						_authListLast = authListLast.slice(innerIndex);
						addNav = tplNavFile(routePath, type);
						
						newContent = `${authListPre}${_authListPre}\n${addNav},\n${_authListLast}`;
					}
					
					fs.writeFile(`./src/layouts/CoreLayout/authList.js` , newContent , function (err) {
				        if (err) console.log(err);
				        console.info(`update ./src/layouts/CoreLayout/authList.js`);
				    });
				});
  			}
		});		

	}
}